# Needed to enable Travis CI for gh-pages branches, see:
#   https://github.com/travis-ci/travis-core/pull/137
branches:
  only:
    - gh-pages

env:
  global:
    - PYENV_PY36_VERSION=3.6.8
    - PYENV_PY37_VERSION=3.7.2
    # NB: Linux shards use Pyenv to pre-install Python. We must not override
    # PYENV_ROOT on those shards, or their Python will no longer work.
    - PYENV_ROOT="${PYENV_ROOT:-${HOME}/.pants_pyenv}"
    - PATH="${PYENV_ROOT}/shims:${PATH}"

test_1_14: &test_1_14 >
  PEX_VERBOSE=9 ./build-support/ci.py
  --pants-versions 1.14.0
  --python-versions unspecified

test_1_15: &test_1_15 >
  PEX_VERBOSE=9 ./build-support/ci.py
  --pants-versions 1.15.0
  --python-versions unspecified 2.7 3.6

test_1_16: &test_1_16 >
  PEX_VERBOSE=9 ./build-support/ci.py
  --pants-versions config
  --python-versions unspecified 2.7 3.6 3.7

test_first_time_install: &test_first_time_install >
  PEX_VERBOSE=9 ./pants test tests:first_time_install

script:
  - *test_1_14
  - *test_1_15
  - *test_1_16
  - *test_first_time_install

cache:
  directories:
    - ${PYENV_ROOT}

osx_setup: &osx_setup
  os: osx
  language: generic
  addons:
    brew:
      packages:
        - openssl
  env:
    - &env_osx_openssl >
      # These flags are necessary to get OpenSSL working on OSX. See
      # https://github.com/pyenv/pyenv/wiki/Common-build-problems#error-the-python-ssl-extension-was-not-compiled-missing-the-openssl-lib.
      PATH="/usr/local/opt/openssl/bin:$PATH"
      LDFLAGS="-L/usr/local/opt/openssl/lib"
      CPPFLAGS="-I/usr/local/opt/openssl/include"
  before_install:
    - ./build-support/install_python_for_ci.sh "${PYENV_PY36_VERSION}" "${PYENV_PY37_VERSION}"
  before_script:
    # Override file handler and thread limits
    - ulimit -c unlimited
    - ulimit -n 8192

matrix:
  include:
    - name: "OSX 10.12 - Sierra"
      <<: *osx_setup
      osx_image: xcode9.2
      env:
        - *env_osx_openssl
        - CACHE_NAME="osx.sierra"
        # OSX 10.12 Sierra frequently flakes when running with Pantsd. Restore the
        # original tests once https://github.com/pantsbuild/pants/issues/6714 and
        # https://github.com/pantsbuild/pants/issues/7323 are resolved.
        - SKIP_PANTSD_TESTS=true

