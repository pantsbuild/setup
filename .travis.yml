# Needed to enable Travis CI for gh-pages branches, see:
#   https://github.com/travis-ci/travis-core/pull/137
branches:
  only:
    - gh-pages

language: python
os: linux

install:
  - pip install tox

script:
  - tox -e test

osx_setup: &osx_setup
  os: osx
  language: generic
  addons:
    brew:
      packages:
        - openssl
  env:
    - &env_osx >
      PATH="/usr/local/opt/openssl/bin:$PATH"
      LDFLAGS="-L/usr/local/opt/openssl/lib"
      CPPFLAGS="-I/usr/local/opt/openssl/include"
      PYENV_PY27_VERSION=2.7.17
      PYENV_PY36_VERSION=3.6.10
      PYENV_PY37_VERSION=3.7.6
      PYENV_PY38_VERSION=3.8.1
      PYENV_ROOT="${HOME}/.pants_pyenv}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY27_VERSION}/bin:${PATH}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY36_VERSION}/bin:${PATH}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY37_VERSION}/bin:${PATH}"
      PATH="${PYENV_ROOT}/versions/${PYENV_PY38_VERSION}/bin:${PATH}"
  before_install:
    - ./build-support/install_python_for_ci.sh "${PYENV_PY27_VERSION}" "${PYENV_PY36_VERSION}" "${PYENV_PY37_VERSION}" "${PYENV_PY38_VERSION}"
  before_script:
    # Override file handler and thread limits
    - ulimit -c unlimited
    - ulimit -n 8192
  cache:
    directories:
      - ${PYENV_ROOT}

jobs:
  include:
    - name: "Lint and check formatting"
      python:
        - "3.6"
      before_install:
        - pyenv global 3.6.7
      addons:
        apt:
          packages:
            - shellcheck
      script:
        - tox -e format-check,lint,typecheck

    - name: "OSX 10.11 - El Capitan"
      <<: *osx_setup
      osx_image: xcode8.0
      env:
        - *env_osx
        - CACHE_NAME="osx.el_capitan"

    - name: "OSX 10.12 - Sierra"
      <<: *osx_setup
      osx_image: xcode9.2
      env:
        - *env_osx
        - CACHE_NAME="osx.sierra"
        # OSX 10.12 Sierra frequently flakes when running with Pantsd. Restore the
        # original tests once https://github.com/pantsbuild/pants/issues/6714 and
        # https://github.com/pantsbuild/pants/issues/7323 are resolved.
        - SKIP_PANTSD_TESTS=true

    - name: "OSX 10.13 - High Sierra"
      <<: *osx_setup
      osx_image: xcode9.4
      env:
        - *env_osx
        - CACHE_NAME="osx.high_sierra"

    - name: "OSX 10.14 - Mojave"
      <<: *osx_setup
      osx_image: xcode11.3
      env:
        - *env_osx
        - CACHE_NAME="osx.mojave"

    - name: "Ubuntu 18.04 - Bionic"
      dist: bionic
      python:
        - "2.7"
        - "3.6"
        - "3.7"
        - "3.8"
      env:
        - CACHE_NAME="linux.bionic"
      before_install:
        - pyenv global 2.7.17 3.6.9 3.7.5 3.8.0
